<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="js/jquery-1.11.3.min.js"></script>
	<link rel="stylesheet" href="css/style.css" type="text/css"/>
	<title>alum</title>
</head>

<body>
	<button id="begin" style="position: fixed; z-index: 4000" >begin</button>
	<audio id="audio" src="musics/alum.mp3"></audio>
	<script type="text/javascript">
		var score = 0;
		var multiplier = 1;
		var combo = 0;
		var offset;
		var currentTime;
		var noteValid = new Array(false, false, false, false, false, false, false);
		var noteList;
		var startTime;
		var jsonReady = false;
		var audioReady = false;
		var audio = document.getElementById("audio");
		var notes = new Array();
		var currentNote = 0;
		var noteImg = document.createElement("img");
		var background = document.createElement("img");
		var foreground = document.createElement("img");
		var canvas = document.createElement("canvas");
		var explodeImg = new Array();
		var explodeEffect = new Array();
		canvas.id = "canvas";
		var context = canvas.getContext("2d");
		var hit = $("<div>");
		background.className = "background";
		foreground.className = "foreground";
		foreground.src = "images/ground/Foreground1.png";
		background.src = "images/ground/Background1.png";
		noteImg.src = "images/note.png";
		(function(){
			for(var i = 1; i <10 ;i++)
			{
	//console.log("fuck" + i);
	explodeImg[i] = document.createElement("img");
	explodeImg[i].src = "images/Explode/hit000" + i +".png";
	explodeImg[0] = null 
}
for(i = 1; i < 7; i++){
	explodeEffect[i] = 0;
}	
})();

canvas.width = 500;
canvas.height = 620;

document.body.appendChild(canvas);
document.body.appendChild(background);
document.body.appendChild(foreground);
//var index = 0;
function refreshCanvas(){
	context.clearRect(0,0,500,620);
	for(x = currentNote; x < notes.length; x++){
		if(notes[x].y <= 620){
			context.drawImage(noteImg,notes[x].x,notes[x].y);
			notes[x].y += 25;
		}
		else{
			currentNote = x;
		}
	}
	for(x = 1; x < 7; x++){
		if(explodeEffect[x] != 0){
			context.drawImage(explodeImg[explodeEffect[x]], x * 70 - 95.5, -110);
			explodeEffect[x]++;
			if(explodeEffect[x] > 9){
				explodeEffect[x] = 0;
			}
		}
	}
	setTimeout(function(){refreshCanvas()}, 20);
}
function fall(noteZone){
	notes.push({"x": noteZone * 70 - 60, "y": -251});
} 

function init(){
	$.getJSON("tabs/alum.json", function(data) {
		console.log("noteList");
		noteList = data;
		console.log(noteList);
		jsonReady = true;
		$(hit).appendTo(document.body);
	}
	);
}

$("#begin").click(function(){
	if(jsonReady && audioReady){
		var dateElem = new Date();
		startTime = dateElem.getTime();
		startPlay(noteList, 0);
		refreshCanvas();
		setTimeout(function(){audio.play();}, 500);
	}
	if(jsonReady == false)
	{
		alert("cannot open jsonFile");
	}
	if(audioReady == false)
	{
		alert("cannot open audioFile");
	}
});
audio.addEventListener('canplaythrough', function(){
	audioReady = true;
});

init();

function startPlay(noteList, bar){
	if(bar >= noteList.bars.length){
		return;
	}
	var dateElem = new Date();
	currentTime = dateElem.getTime();
	offset = currentTime - startTime - (audio.currentTime * 1000) - 500;
	console.log("offset:" + offset);
	for(x in noteList.bars[bar].notes){
		setTimeout("fall(" + noteList.bars[bar].notes[x].note + ")", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 - 500 + offset - 230);
		setTimeout("noteValid[" + noteList.bars[bar].notes[x].note + "] = true", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 - 100 + offset - 150);
		setTimeout("if(noteValid[" + noteList.bars[bar].notes[x].note + "]== true){noteValid[" + noteList.bars[bar].notes[x].note + "] = false; miss();}", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 + 100 + offset - 150);
	}
	if(bar % 3 == 0){
		setTimeout(function(){startPlay(noteList, bar + 1);}, 2666);
	}
	else{
		setTimeout(function(){startPlay(noteList, bar + 1);}, 2667);
	}
}

function explode(x){
	combo++;
	multiplier = Number(Number(combo / 10 + 1).toFixed(0));
	score += multiplier;

	hitEffect(true,combo);
	//console.log("combo: " + combo + "multiplier" + multiplier + "score" + score);
	noteValid[x] = false;
	explodeEffect[x] = 1;
}

function miss(){
	//console.log("missed!sb");

	hitEffect(false,0);
	combo = 0;
	multiplier = 1;
}

document.onkeydown = function(e){
	if(e.keyCode == 83){
		if(noteValid[1] == true){
			explode(1);
		}
		else{
			miss();
		}
	}
	if(e.keyCode == 68){
		if(noteValid[2] == true){
			explode(2);
		}
		else{
			miss();
		}
	}
	if(e.keyCode == 70){
		if(noteValid[3] == true){
			explode(3);
		}
		else{
			miss();
		}
	}
	if(e.keyCode == 74){
		if(noteValid[4] == true){
			explode(4);
		}
		else{
			miss();
		}
	}
	if(e.keyCode == 75){
		if(noteValid[5] == true){
			explode(5);
		}
		else{
			miss();
		}
	}
	if(e.keyCode == 76){
		if(noteValid[6] == true){
			explode(6);
		}
		else{
			miss();
		}
	}
}
function hitEffect(hitFlag,hitTimes){
	if(hitFlag == true)
	{
		hit.attr("class","hitNeon");
		hit.html(hitTimes+"hit");
	}
	else
	{
		hit.attr("class","missNeon");
		hit.html("miss");
	}
	hit.stop(true, true);
	hit.show();
	hit.fadeOut();
}
</script>
</body>

</html>
