<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="js/jquery-1.11.3.min.js"></script>
	<link rel="stylesheet" href="css/style.css" type="text/css"/>
	<title>alum</title>
</head>

<body>
	<button id="begin" style="position: fixed; z-index: 4000;cursor:pointer;">begin</button>
	<audio id="audio" src="musics/alum.mp3"></audio>
	<script type="text/javascript">
	var score = 0;
	var multiplier = 1;
	var combo = 0;
	var maxCombo = 0;
	var offset;
	var currentTime;
	var noteValid = new Array(false, false, false, false, false, false, false);
	var noteList;
	var startTime;
	var jsonReady = false;
	var audioReady = false;
	var audio = document.getElementById("audio");
	var notes = new Array();
	var currentNote = 0;
	var noteImg = document.createElement("img");
	var supNoteImg = document.createElement("img");
	var background = document.createElement("img");
	var foreground = document.createElement("img");
	var canvas = document.createElement("canvas");
	var explodeImg = new Array();
	var explodeEffect = new Array();
	var ifSupNote = false;
	var superNoteValid = new Array(false, false, false, false, false, false, false);
	var endFlag = false;
	var missNotes = 0;
	var correctNotes = 0;
	var accuracy = 1;
	var infoZone = $("<div>");
	var resultPage = $("<div>");
	var restart = $("<button>");
	resultPage.attr("class","resultPage");
	infoZone.attr("class","infoZone").appendTo(document.body);
	var showMulti = $("<p>");
	showMulti.attr("class","multiZone");
	//showMulti.html("x"+multiplier);
	showMulti.appendTo($(".infoZone"));
	var showScore = $("<p>");
	showScore.attr("class","scoreZone");
	showScore.appendTo($(".infoZone"));
	//showScore.html(score);
	$("<hr>").appendTo($(".infoZone"));
	var showAccuracy = $("<p>");
	showAccuracy.attr("class","accuracyZone");
	showAccuracy.appendTo($(".infoZone"));
	canvas.id = "canvas";
	var context = canvas.getContext("2d");
	var hit = $("<div>");
	background.className = "background";
	foreground.className = "foreground";
	foreground.src = "images/ground/Foreground1.png";
	background.src = "images/ground/Background1.png";
	noteImg.src = "images/note.png";
	supNoteImg.src = "images/noteSuper.png";
	var missEffect = new Array();
	var missImg = new Array();
	function showResults(){
		resultPage.html("");
		var finalScore = $("<p>");
		finalScore.html("finalScore:"+score);
		finalScore.attr("class","finalScore");
		finalScore.appendTo(resultPage);
		var finalAccuracy = $("<p>");
		finalAccuracy.html("finalAccuracy:"+accuracy.toPercent());
		finalAccuracy.attr("class","finalAccuracy");
		finalAccuracy.appendTo(resultPage);
		var finalMaxCombo = $("<p>");
		finalMaxCombo.html("MaxCombo:"+maxCombo);
		finalMaxCombo.attr("class","finalMaxCombo");
		finalMaxCombo.appendTo(resultPage);
		
		restart.attr("class","restart");
		restart.html("restart");
		restart.appendTo(resultPage);
		resultPage.appendTo(document.body);
		$(".background").animate({opacity:'0.5'},500);
		$(".foreground").animate({opacity:'0.5'},500);
		infoZone.fadeOut();
		resultPage.fadeIn();
	}
	restart.click(function(){
		location.reload();
		notes = new Array();
		score = 0;
		multiplier = 0;
		accuracy = 1;
		maxCombo = 0;
		combo = 0;
	showScore.html(score);
	showAccuracy.html(accuracy.toPercent());
	showMulti.html("x"+multiplier);
		$("#begin").fadeOut(300);
		$(".infoZone").fadeIn(300);
		$(".background").animate({opacity:'1'},500);
		$(".foreground").animate({opacity:'1'},500);
		resultPage.fadeOut();
		var dateElem = new Date();
		startTime = dateElem.getTime();
		startPlay(noteList, 0);
		refreshCanvas();
		audio.fastSeek(0);
		audio.pause();
		setTimeout(function(){audio.play();}, 575);
	});
	(function(){
		for(var i = 1; i <9 ;i++)
		{
			missImg[i] = document.createElement("img");
			missImg[i].src = "images/miss/miss000" + i +".png";
			missImg[0] = null 
		}
		for(i = 1; i < 7; i++){
			missEffect[i] = 0;
		}	
	})();
	(function(){
		for(var i = 1; i <10 ;i++)
		{
			explodeImg[i] = document.createElement("img");
			explodeImg[i].src = "images/Explode/hit000" + i +".png";
			explodeImg[0] = null 
		}
		for(i = 1; i < 7; i++){
			explodeEffect[i] = 0;
		}	
	})();

	canvas.width = 500;
	canvas.height = 620;

	document.body.appendChild(canvas);
	document.body.appendChild(background);
	document.body.appendChild(foreground);
//var index = 0;
function refreshCanvas(){
	context.clearRect(0,0,500,620);
	for(x = currentNote; x < notes.length; x++){
		if(notes[x].y <= 620){
			if(notes[x].type == 0){
				context.drawImage(noteImg,notes[x].x,notes[x].y);
				notes[x].y += 25;
			}else{
				context.drawImage(supNoteImg,notes[x].x,notes[x].y);
				notes[x].y += 25;
			}
		}
		else{
			currentNote = x;
		}
	}
	for(x = 1; x < 7; x++){
		if(explodeEffect[x] != 0){
			context.drawImage(explodeImg[explodeEffect[x]], x * 70 - 95.5, -110);
			explodeEffect[x]++;
			if(explodeEffect[x] > 9){
				explodeEffect[x] = 0;
			}
		}
	}
	for(x = 1; x < 7; x++){
		if(missEffect[x] != 0){
			context.drawImage(missImg[missEffect[x]], x * 70 - 303.5, + 170);
			missEffect[x]++;
			if(missEffect[x] > 8){
				missEffect[x] = 0;
			}
		}
	}
	if (endFlag == false) {setTimeout(function(){refreshCanvas()}, 20);};
}
function fall(noteZone){
	if(ifSupNote == true){
		notes.push({"type": 1, "x": noteZone * 70 - 60, "y": -251});
		ifSupNote = false;
		setTimeout("superNoteValid[" + noteZone + "] = true", 420);
		setTimeout("superNoteValid[" + noteZone + "] = false", 580);
	}else{
		notes.push({"type": 0, "x": noteZone * 70 - 60, "y": -251});
	}
} 

function init(){
	$.getJSON("tabs/alum.json", function(data) {
		noteList = data;
		jsonReady = true;
		$(hit).appendTo(document.body);
	}
	);
}

$("#begin").click(function(){
	if(jsonReady && audioReady){
		$("#begin").fadeOut(300);
		$(".infoZone").fadeIn(300);
		$(".background").animate({opacity:'1'},500);
		$(".foreground").animate({opacity:'1'},500);
		var dateElem = new Date();
		startTime = dateElem.getTime();
		startPlay(noteList, 0);
		refreshCanvas();
		setTimeout(function(){audio.play();}, 600);
	showScore.html(score)
	showAccuracy.html(accuracy.toPercent());
	showMulti.html("x"+multiplier);
	}
	if(jsonReady == false)
	{
		alert("cannot open jsonFile");
	}
	if(audioReady == false)
	{
		alert("cannot open audioFile");
	}
});
audio.addEventListener('canplaythrough', function(){
	audioReady = true;
});

init();

function startPlay(noteList, bar){
	if(bar >= noteList.bars.length){
		if(bar >= noteList.bars.length + 2){
		endFlag = true;
		showResults();
		return;
	}
	}else{
	var dateElem = new Date();
	currentTime = dateElem.getTime();
	offset = currentTime - startTime - (audio.currentTime * 1000) - 600;
	console.log("offset:" + offset);
	for(x in noteList.bars[bar].notes){
		setTimeout("fall(" + noteList.bars[bar].notes[x].note + ")", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 - 500 + offset - 180);
		setTimeout("noteValid[" + noteList.bars[bar].notes[x].note + "] = true", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 - 120 + offset - 100);
		setTimeout("if(noteValid[" + noteList.bars[bar].notes[x].note + "]== true){noteValid[" + noteList.bars[bar].notes[x].note + "] = false; miss(" + noteList.bars[bar].notes[x].note + ");}", (noteList.bars[bar].notes[x].time) * 1000 * 2 / 3 + 120 + offset - 100);
	}}
	if(bar % 3 == 0){
		setTimeout(function(){startPlay(noteList, bar + 1);}, 2666);
	}
	else{
		setTimeout(function(){startPlay(noteList, bar + 1);}, 2667);
	}
}
Number.prototype.toPercent = function(){
	return (Math.round(this * 10000)/100).toFixed(2) + '%';
}
function explode(x){
	combo++;
	if(combo > maxCombo)
	{
		maxCombo = combo;
	}
	correctNotes++;
	if(combo%10 == 0){
		multiplier++;
	}
	if(superNoteValid[x]){
		multiplier++;
	}
	score += multiplier * 50;
	if(combo%13 == 0){
		ifSupNote = true;
	}
	showScore.html(score);
	hitEffect(true,combo);
	//console.log("combo: " + combo + "multiplier" + multiplier + "score" + score);
	noteValid[x] = false;
	explodeEffect[x] = 1;
	accuracy = correctNotes/(correctNotes+missNotes);
	showAccuracy.html(accuracy.toPercent());
	showMulti.html("x"+multiplier);
}

function miss(x){
	//console.log("missed!sb");
	missEffect[x] = 1;
	hitEffect(false,0);
	combo = 0;
	multiplier = 1;
	missNotes++;
	showScore.html(score);
	accuracy = correctNotes/(correctNotes+missNotes);
	showAccuracy.html(accuracy.toPercent());
	showMulti.html("x"+multiplier);
}

document.onkeydown = function(e){
	if(e.keyCode == 83){
		if(noteValid[1] == true){
			explode(1);
		}
		else{
			miss(1);
		}
	}
	if(e.keyCode == 68){
		if(noteValid[2] == true){
			explode(2);
		}
		else{
			miss(2);
		}
	}
	if(e.keyCode == 70){
		if(noteValid[3] == true){
			explode(3);
		}
		else{
			miss(3);
		}
	}
	if(e.keyCode == 74){
		if(noteValid[4] == true){
			explode(4);
		}
		else{
			miss(4);
		}
	}
	if(e.keyCode == 75){
		if(noteValid[5] == true){
			explode(5);
		}
		else{
			miss(5);
		}
	}
	if(e.keyCode == 76){
		if(noteValid[6] == true){
			explode(6);
		}
		else{
			miss(6);
		}
	}
}

function hitEffect(hitFlag,hitTimes){
	if(hitFlag == true)
	{
		hit.attr("class","hitNeon");
		hit.html(hitTimes);
	}
	else
	{
		hit.attr("class","missNeon");
		hit.html("X");
	}
	hit.stop(true, true);
	hit.show();
	hit.fadeOut();
}
</script>
</body>

</html>
